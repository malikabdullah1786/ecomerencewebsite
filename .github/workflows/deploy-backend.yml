name: Deploy Backend to Azure VM
on:
  push:
    branches: [ main ]
    paths:
      - 'server/**'
      - '.github/workflows/deploy-backend.yml'

jobs:
  deploy:
    name: ğŸš€ Deploy to Azure
    runs-on: ubuntu-latest
    steps:
      - name: ğŸ”Œ Connect & Update
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.AZURE_HOST }}
          username: ${{ secrets.AZURE_USERNAME }}
          key: ${{ secrets.AZURE_KEY }}
          script: |
            # âš ï¸ IMPORTANT: Change 'tarzify-store' to your actual repository folder name on the VM
            cd ~/tarzify-store/server || exit
            
            # Get latest changes
            git pull origin main
            
            # Install new dependencies
            npm install
            
            # Rebuild the backend
            npm run build
            
            # Restart the server (using PM2)
            pm2 restart tarzify-backend || pm2 start dist/index.js --name "tarzify-backend"
